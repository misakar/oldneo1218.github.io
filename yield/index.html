<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    
    
    <!-- google site -->
    <meta name="google-site-verification" content="BazmSJ55LY7H3RD6ttelAsE8PmOPjhkFnDdIjFMCiJE" />
    <title>neo1218ã®æ­»å®… - POST</title>
    <link rel="shortcut icon" href="http://7xj431.com1.z0.glb.clouddn.com/cropped-150-150-688417.png" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href=/static/css/base_site.css>
    <link rel="stylesheet" type="text/css" href=/static/css/index.css>
    <link rel="stylesheet" type="text/css" href=/static/css/post.css>
    <link rel="stylesheet" type="text/css" href=/static/css/self_card.css>
    <link rel="stylesheet" type="text/css" href=/static/css/github.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/github.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/facebook.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/twitter.css>
    <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link href=/static/image/bg.png>
</head>
<body>
<header>
    <div class="top-z-container">
        <!--blur-->
        <div class="blur-top-image"></div>
        <div id="top-bar">
            <nav class="left-box">
                <ul>
                    <li>
                        <a href=/>neo1218ã®æ­»å®…</a> - Pythoner æ­»å®…åˆ°åº• ä¸æƒ³è¯´è¯ æœ¨çŠ€ä¸‡å²!
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    <div id="top-image"></div>
    <nav class="nav-wrapper">
        <ul class="category-list">
            <li>
                <a href=/>
                    <span>é¦–é¡µ</span>
                    <div class="menu-icon-wrapper">
                        <span class="menu-icon icon-no-bg-color fa fa-home"></span>
                    </div>
                </a>
            </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Web/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">7</span>
                        </div>
                        Web
                    </a>
                    <ul class="drop-down" align="center">
                        <span>Webå¼€å‘</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Life/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">3</span>
                        </div>
                        Life
                    </a>
                    <ul class="drop-down" align="center">
                        <span>ç”Ÿæ´»éšç¬”</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Read/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">1</span>
                        </div>
                        Read
                    </a>
                    <ul class="drop-down" align="center">
                        <span>è¯»ä¹¦</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Python/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">16</span>
                        </div>
                        Python
                    </a>
                    <ul class="drop-down" align="center">
                        <span>Pythonå­¦ä¹ </span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Other/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">3</span>
                        </div>
                        Other
                    </a>
                    <ul class="drop-down" align="center">
                        <span>å…¶ä»–</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/DIY/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">4</span>
                        </div>
                        DIY
                    </a>
                    <ul class="drop-down" align="center">
                        <span>ä¸ªäººé¡¹ç›®</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/C%26Cpp/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">1</span>
                        </div>
                        C&amp;Cpp
                    </a>
                    <ul class="drop-down" align="center">
                        <span>å™¶å“ˆå“ˆ</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/OS/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">5</span>
                        </div>
                        OS
                    </a>
                    <ul class="drop-down" align="center">
                        <span>æ“ä½œç³»ç»Ÿå­¦ä¹ </span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Algo/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">7</span>
                        </div>
                        Algo
                    </a>
                    <ul class="drop-down" align="center">
                        <span>ç®—æ³•å­¦ä¹ </span>
                    </ul>
                </li>
            
            <li>
                <a href=/about/>
                    <span>å…³äº</span>
                    <div class="menu-icon-wrapper">
                        <span class="menu-icon icon-no-bg-color fa fa-info"></span>
                    </div>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main>
    <div id="main">
        
<div class="post-body-wrapper">
    <div class="main_post">
        <h1>å…³äºPython yieldçš„ä¸€äº›å¸¸è¯†</h1>
        <h3>2016-11-10 18:28:10</h3>
        <div class="post_body">
            <p><img alt="" src="http://7xj431.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-11-10%20%E4%B8%8B%E5%8D%886.41.12.png" /></p>

<h1 id="python-yield">å…³äºPython yieldçš„ä¸€äº›å¸¸è¯†</h1>

<h2 id="1-yield">1. yieldå…³é”®å­—</h2>

<p><a href="https://www.python.org/dev/peps/pep-0255/">PEP 255 &ndash; Simple Generators</a>ä¸­å¼•å…¥äº†yieldå…³é”®å­—:</p>

<pre><code>This PEP introduces the concept of generators to Python, as well
as a new statement used in conjunction with them, the "yield"
statement.
</code></pre>

<p>yieldå…³é”®å­—ç”¨æ¥å®ç°ç”Ÿæˆå™¨. <br/><br />
ä»€ä¹ˆæ˜¯ç”Ÿæˆå™¨å‘¢? ç”Ÿæˆå™¨æ˜¯ä¸€ä¸ª<strong>å¯è¿­ä»£</strong>çš„å¯¹è±¡(å®ç°äº†<code>__iter__</code>æ–¹æ³•çš„å¯¹è±¡).<br />
ä½†ç›¸æ¯”äºåˆ—è¡¨ã€å…ƒç»„ç­‰å¯è¿­ä»£å¯¹è±¡, ç”Ÿæˆå™¨çš„è°ƒç”¨ä¸ä¼šç«‹å³æ‰§è¡Œå¾—åˆ°ç»“æœ, è€Œæ˜¯è¿”å›ä¸€ä¸ªgeneratorå¯¹è±¡, æ¯æ¬¡æ‰‹åŠ¨è°ƒç”¨nextæ‰§è¡Œç”Ÿæˆå™¨å¯¹è±¡æ‰èƒ½å¾—åˆ°ç»“æœ, æ¯”å¦‚:</p>

<pre><code>In [23]: def generator():
...:     print('--- start ---')
...:     yield 1
...:     print('--- end ---')
...:     yield 2
...:
In [24]: gen = generator()

In [25]: gen
Out[25]: &lt;generator object generator at 0x110361bf8&gt;

In [26]: next(gen)
--- start ---
Out[26]: 1

In [27]: next(gen)
--- end ---
Out[27]: 2

In [28]: next(gen)
---------------------------------------------------------------------------
StopIteration                             Traceback (most recent call last)
&lt;ipython-input-28-8a6233884a6c&gt; in &lt;module&gt;()
----&gt; 1 next(gen)

StopIteration:
</code></pre>

<p>å½“ç”Ÿæˆå™¨è¿­ä»£ç»“æŸæ—¶, ä¼šraiseä¸€ä¸ªStopIterationé”™è¯¯. <br/><br />
å¯æ˜¯, è¿™ç©¶ç«Ÿæœ‰ä»€ä¹ˆç”¨å‘¢? æŠŠå¥½å¥½çš„ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡çš„æ‰§è¡Œæµæ‹†çš„å››åˆ†äº”è£‚? <br/></p>

<p>éœ€è¦æ³¨æ„åˆ°çš„æ˜¯: <strong>ç”Ÿæˆå™¨æ˜¯ä¸€ä¸ªå‡½æ•°</strong>, å‡½æ•°å°±æ˜¯ä¸€æ®µæ‰§è¡Œæµ,<br />
ä¹Ÿå°±æ˜¯è¯´é€šè¿‡yield, æˆ‘ä»¬å¯ä»¥æŠŠä¸€ä¸ªå‡½æ•°æ‰§è¡Œæµåˆ’åˆ†æˆæ›´ç»†çš„æ‰§è¡Œæµ,<br />
è€Œä¸”å¯ä»¥é€šè¿‡nextæ‰‹åŠ¨è°ƒåº¦. å°±ç®—ä¸­é—´å‘ç”Ÿåˆ‡æ¢ä¹Ÿæ²¡å…³ç³»,<br />
ç”Ÿæˆå™¨å¸®æˆ‘ä»¬ä¿å­˜äº†æ‰§è¡Œæ—¶ç¯å¢ƒä¿¡æ¯!(æ”¾åœ¨å†…å­˜ä¸­). <br />
<hr/><br />
è¿™å°±å¼€å§‹å˜å¾—æœ‰æ„æ€äº†, å¦‚æœæ²¡æœ‰æ„Ÿè§‰åˆ°, å¯ä»¥æƒ³æƒ³: è¿›ç¨‹ã€çº¿ç¨‹ã€ä¸­æ–­:) <br/><br />
æ­¤å¤–, è¿˜å¯ä»¥ç”¨å…ƒç»„ç”Ÿæˆå¼åˆ›å»ºç”Ÿæˆå™¨:</p>

<pre><code>In [29]: lt = [1, 2, 3, 4]

In [30]: gen = (i for i in lt)

In [31]: gen
Out[31]: &lt;generator object &lt;genexpr&gt; at 0x110213938&gt;

In [32]: next(gen)
Out[32]: 1
</code></pre>

<p>è¿™é‡Œçš„ç”Ÿæˆå™¨genæ›´åƒæ˜¯åˆ—è¡¨è¿™æ ·çš„å®¹å™¨, ä¸è¿‡ç›¸æ¯”äºåˆ—è¡¨, ç”Ÿæˆå™¨å ç”¨çš„å†…å­˜æ›´å°‘,<br />
å› ä¸ºä¸ç”¨æŠŠå…¨éƒ¨ç»“æœå­˜æ”¾åœ¨å†…å­˜ä¸­:) <br/><br />
ç”Ÿæˆå™¨è¿˜æœ‰ä¸€ä¸ªæœ‰æ„æ€çš„ç‰¹æ€§<strong>sendæ–¹æ³•</strong>:</p>

<pre><code>In [34]: def double_result():
    ...:     x = yield
    ...:     yield x * 2
    ...:

In [35]: gen = double_result()

In [36]: gen
Out[36]: &lt;generator object double_result at 0x1103922b0&gt;

In [37]: gen.send(None) # next(gen)

In [38]: gen.send(4)
Out[38]: 8
</code></pre>

<p>è¿™é‡Œä¸»çº¿ç¨‹è°ƒç”¨sendæ–¹æ³•, å°†æ‰§è¡Œæµäº¤ç»™gen(double_resultå‡½æ•°), ç›¸å½“äºæ‰§è¡Œnext(gen), å¹¶ä¸”ä¼ é€’äº†ä¸€ä¸ªå€¼ç»™gen[x = yield]. sendæ–¹æ³•è¿”å›genæ¯æ¬¡æ‰§è¡Œçš„ç»“æœ. <br/><br />
ä¸»çº¿ç¨‹å’Œç”Ÿæˆå™¨æ‰§è¡Œæµé—´çš„äº¤äº’, å°±æ˜¯è¿™ä¹ˆç¾å¦™ã€ç›´æ¥!;</p>

<h2 id="2-yield">2. yieldå…³é”®å­—çš„ç”¨å¤„</h2>

<p>ä¸Šé¢è¯´çš„æ›´å¤šå…³æ³¨ç”Ÿæˆå™¨æœ¬èº«çš„ç‰¹æ€§, è¿™ä¸€éƒ¨åˆ†ä¼šä»‹ç»ç”Ÿæˆå™¨(yield)çš„å®é™…ä½¿ç”¨.</p>

<h3 id="_1">ç®¡é“?</h3>

<p>è¿™ä¸ªéƒ¨åˆ†ä¸»è¦å‚è€ƒ<a href="http://www.dabeaz.com/generators/Generators.pdf">Dabeazçš„Generators pdf</a>. <br/><br />
å½“æˆ‘çœ‹åˆ°Dabeazçš„Generators pdf, çœ‹åˆ°é‡Œé¢æ‰€ä¸¾çš„ä¾‹å­, è™½ç„¶éƒ½æ˜¯ç”Ÿæˆå™¨å¸¸è§„æ™®é€šçš„ç”¨æ³•, ä½†æ˜¯å°†ç”Ÿæˆå™¨ä½œä¸ºä¸­é—´å¯¹è±¡, å¿½ç•¥ç»†èŠ‚, æŠŠç”Ÿæˆå™¨å½“ä½œä¸€ä¸ªå†…å­˜å ç”¨å°‘çš„æ•´ä½“ä½œä¸ºç®¡é“pipelineè¿æ¥2ä¸ªå¤„ç†ç¨‹åº, è¿™ç§unix styleè¿˜æ˜¯è®©æˆ‘ååˆ†æƒŠè®¶, ç”¨Dabeazçš„è¯æ¥è¯´å°±æ˜¯<strong>Think Big</strong> <br/><br />
æ¯”å¦‚, ç°åœ¨æœ‰ä¸€ä¸ªGBçº§åˆ«çš„nginx logæ—¥å¿—, æˆ‘ä»¬å¸Œæœ›æ‹¿åˆ°å…¨éƒ¨ip(ä¸é‡å¤)åšè¿›ä¸€æ­¥å¤„ç†(ç»Ÿè®¡ã€åˆ†æ&hellip;). <br/><br />
é¦–å…ˆ:</p>

<ul>
<li>æ‰“å¼€æ—¥å¿—æ–‡ä»¶, å°†æ—¥å¿—æ”¾åˆ°ä¸€ä¸ª<strong>ç”Ÿæˆå™¨</strong>ä¸­</li>
<li>è¯»å–<strong>ç”Ÿæˆå™¨</strong>ä¸­æ—¥å¿—æ‹¿åˆ°ipæ”¾åˆ°ä¸€ä¸ª<strong>ç”Ÿæˆå™¨</strong>ä¸­</li>
<li>åˆ©ç”¨é›†åˆå¯¹ip<strong>ç”Ÿæˆå™¨</strong>è¿›è¡Œå»é‡, å¾—åˆ°æ‰€æœ‰ipé›†åˆ</li>
</ul>

<pre><code>nginx_log = open('big-nginx-access.log')
ip_columns = (line.split()[0] for line in nginx_log)
ip_set = set(ip_columns)
</code></pre>

<p>æ‰§è¡Œçš„æµç¨‹å›¾:</p>

<p><img alt="" src="http://7xj431.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-11-10%20%E4%B8%8B%E5%8D%888.16.15.png" /> <br/></p>

<h3 id="_2">ä¸Šä¸‹æ–‡ç®¡ç†å™¨</h3>

<p>åœ¨ç¼–ç¨‹ä¸­æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°è¿™äº›æƒ…å†µ:</p>

<pre><code>f = open()
......
f.close()

lock.acquire()
......
lock.release()

db.start_transaction()
......
db.commit()
</code></pre>

<p>ä¸€èˆ¬æˆ‘ä»¬ä¼šä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨å¤„ç†è¿™äº›æƒ…å†µ, ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨å…³é—­äº‹åŠ¡,<br />
æˆ‘ä»¬åªéœ€è¦ä¸“æ³¨æ ¸å¿ƒå¤„ç†ä»£ç å°±è¡Œäº†. <br/><br />
æ‰€è°“ä¸Šä¸‹æ–‡ç®¡ç†å™¨å°±æ˜¯å®ç°äº†<code>__enter__</code>å’Œ<code>__exit__</code>æ–¹æ³•çš„ç±»,<br />
æ¯”å¦‚åœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­åˆ›å»ºå¹¶ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶</p>

<pre><code>class tempdir(object):
    def __enter__(self):
        self.dirname = tempfile.mkdtemp()
        return self.dirname

    def __exit__(self):
        shutil.rmtree(self.dirname)
</code></pre>

<p>è¿™æ ·å°±å¯ä»¥ä½¿ç”¨</p>

<pre><code>with tempdir() as value:
    # æ ¸å¿ƒä»£ç !
</code></pre>

<p>Pythonè¿˜æä¾›äº†ä¸€ä¸ª<strong>@contextmanagerè£…é¥°å™¨</strong>æ–¹ä¾¿æˆ‘ä»¬ç¼–å†™ä¸Šä¸‹æ–‡ç®¡ç†å™¨</p>

<pre><code>@contextmanager
def tempdir():
    dirname = tempdir.mkdtemp()
    try:
        yield dirname
    finally:
        shutil.rmtree(dirname)
</code></pre>

<p>å…¶å®<code>@contextmanager</code>è£…é¥°å™¨åªæ˜¯å¯¹ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç±»ä»£ç çš„é‡æ„, é‡æ„çš„å…³é”®å°±æ˜¯</p>

<pre><code>yield dirname
</code></pre>

<p>è¿™é‡Œçš„yield! <br/><br />
ç¬¬ä¸€çœ¼çœ‹åˆ°è¿™ä¸ªyieldçš„æ—¶å€™, æˆ‘æ˜¯æ‡µbçš„, è¿™ä¸ªyieldåˆ°åº•æ˜¯åšä»€ä¹ˆçš„?<br />
è¿™å°±éœ€è¦çœ‹çœ‹contextmanagerè£…é¥°å™¨çš„å®ç°äº† <br/><br />
contextmanagerè£…é¥°å™¨å¤§è‡´å®ç°éƒ¨åˆ†å¦‚ä¸‹: <br/><br />
è£…é¥°å™¨éƒ¨åˆ†:</p>

<pre><code>def contextmanager(func):
    def run(*args, **kwargs):
        return GeneratorCM(func(*args, **kwargs))
    return func
</code></pre>

<p>å†æ¥çœ‹çœ‹GeneratorCMç±»çš„å¤§è‡´å®ç°:</p>

<pre><code>class GeneratorCM(object):
    def __init__(self, gen):
        self.gen = gen

    def __enter__(self):
        return next(gen)  # æ‰§è¡Œç”Ÿæˆå™¨, æ‹¿åˆ°dirname (value)

    def __exit__(self, exc_type):
        try:
            if exc_type is None:
                next(self.gen)
            else:
                self.gen.throw(exc_type)
        except StopIteration: # åˆ©ç”¨StopIterationé€€å‡ºä¸Šä¸‹æ–‡
            return True
</code></pre>

<p>åŸæ¥yieldå°†è¢«ä¿®é¥°çš„å‡½æ•°å˜æˆç”Ÿæˆå™¨,<br />
è¿˜è®°å¾—ä¹‹å‰è¯´è¿‡çš„å¯ä»¥é€šè¿‡nextå®ç°ç”Ÿæˆå™¨æ‰§è¡Œæµæ›´ç»†ç²’çš„è°ƒåº¦å—?<br />
è¿™é‡ŒæŠŠç¢°åˆ°yieldä¹‹å‰çš„ä»£ç ä½œä¸º<code>__enter__</code>éƒ¨åˆ†,<br />
æŠŠåé¢æ‰§è¡Œè§¦å‘StopIterationé”™è¯¯çš„ä»£ç ä½œä¸º<code>__exit__</code>éƒ¨åˆ†å®ç°ä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„é€€å‡º.<br/><br />
ç°åœ¨çŸ¥é“ä¸ºä»€ä¹ˆè¦æŠŠä¸€ä¸ªå‡½æ•°æ‰§è¡Œæµå¼„çš„å››åˆ†äº”è£‚äº†å§ ğŸ˜„<br />
 <br/></p>

<h2 id="_3">ä»Šå¤©å…ˆå†™è¿™ä¹ˆå¤š, æ˜å¤©ç»§ç»­!</h2>

<h3 id="_4">ç”Ÿæˆå™¨ç”¨äºå¼‚æ­¥è°ƒåº¦</h3>

<h3 id="_5">åç¨‹: å•çº¿ç¨‹å¹¶å‘</h3>

        </div>
    </div>
    <div id="disqus_thread" style="padding: 50px"></div>
    <script>
    /**
    * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = '//neo1218flask.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

    </div>
</main>
<footer>
    <div id="foot">
        
            <div class="footer">
                <span>
                    Powered by:
                    <a href="https://github.com/neo1218/railgun/" target="_blank">railgun</a>
                    I am a loser
                </span>
                <br>
            </div>
        
    </div>
</footer>
<div id="back-to-top" data-scroll="body" style="top: -900px;">
</div>
</body>
    <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
    <script src=/static/js/base_site.js></script>
    <script src=/static/js/disqus/embed.js></script>
    <script src=/static/js/menufix.js></script>
    <script src=/static/js/backtotop.js></script>
    <script type="text/javascript">
        function loadMenuFix() { menufix("info_card"); }
        function loadDeadCat() { deadcat("toTop"); }
        function addLoadEvent(func) {
            var oldonload = window.onload;
            if (typeof window.onload != 'function') {
                window.onload = func;
            } else {
                window.onload = function() {
                    if (oldonload) {
                        oldonload();
                    }
                    func();
                }
            }
        }
        addLoadEvent(loadMenuFix);
        // addLoadEvent(loadDeadCat);
    </script>
</html>