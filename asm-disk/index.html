<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    
    
    <!-- google site -->
    <meta name="google-site-verification" content="BazmSJ55LY7H3RD6ttelAsE8PmOPjhkFnDdIjFMCiJE" />
    <title>neo1218の家 - POST</title>
    <link rel="shortcut icon" href="http://7xj431.com1.z0.glb.clouddn.com/cropped-150-150-688417.png" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href=/static/css/base_site.css>
    <link rel="stylesheet" type="text/css" href=/static/css/index.css>
    <link rel="stylesheet" type="text/css" href=/static/css/post.css>
    <link rel="stylesheet" type="text/css" href=/static/css/self_card.css>
    <link rel="stylesheet" type="text/css" href=/static/css/github.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/github.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/facebook.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/twitter.css>
    <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link href=/static/image/bg.png>
</head>
<body>
<header>
    <div class="top-z-container">
        <!--blur-->
        <div class="blur-top-image"></div>
        <div id="top-bar">
            <nav class="left-box">
                <ul>
                    <li>
                        <a href=/>neo1218の家</a> - Pythoner Vimer 木犀 hacker
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    <div id="top-image"></div>
    <nav class="nav-wrapper">
        <ul class="category-list">
            <li>
                <a href=/>
                    <span>首页</span>
                    <div class="menu-icon-wrapper">
                        <span class="menu-icon icon-no-bg-color fa fa-home"></span>
                    </div>
                </a>
            </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Web/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">9</span>
                        </div>
                        Web
                    </a>
                    <ul class="drop-down" align="center">
                        <span>Web开发</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Life/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">3</span>
                        </div>
                        Life
                    </a>
                    <ul class="drop-down" align="center">
                        <span>生活随笔</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Read/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">1</span>
                        </div>
                        Read
                    </a>
                    <ul class="drop-down" align="center">
                        <span>读书</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Python/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">16</span>
                        </div>
                        Python
                    </a>
                    <ul class="drop-down" align="center">
                        <span>Python学习</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Other/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">3</span>
                        </div>
                        Other
                    </a>
                    <ul class="drop-down" align="center">
                        <span>其他</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/DIY/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">4</span>
                        </div>
                        DIY
                    </a>
                    <ul class="drop-down" align="center">
                        <span>个人项目</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/C%26Cpp/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">1</span>
                        </div>
                        C&amp;Cpp
                    </a>
                    <ul class="drop-down" align="center">
                        <span>噶哈哈</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/OS/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">7</span>
                        </div>
                        OS
                    </a>
                    <ul class="drop-down" align="center">
                        <span>操作系统学习</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Math/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">1</span>
                        </div>
                        Math
                    </a>
                    <ul class="drop-down" align="center">
                        <span>数学之美</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Algo/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">7</span>
                        </div>
                        Algo
                    </a>
                    <ul class="drop-down" align="center">
                        <span>算法学习</span>
                    </ul>
                </li>
            
            <li>
                <a href=/about/>
                    <span>关于</span>
                    <div class="menu-icon-wrapper">
                        <span class="menu-icon icon-no-bg-color fa fa-info"></span>
                    </div>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main>
    <div id="main">
        
<div class="post-body-wrapper">
    <div class="main_post">
        <h1>用汇编读写硬盘</h1>
        <h3>2016-12-13 19:45:00</h3>
        <div class="post_body">
            <div id="post">
                <h1 id="_1">用汇编读写硬盘</h1>
<p>直接用汇编读写硬盘, 很cool, 但是有点麻烦, 在此做个简单的纪录📝 </p>
<h2 id="_2">硬盘适配器端口及功能分配</h2>
<p>在这篇博客<a href="https://neo1218.github.io/disk/">呃,硬盘</a>里</p>
<h2 id="_3">读写步骤</h2>
<h3 id="step0">step0: 备份寄存器</h3>
<p>硬盘读写会用到eax, cx寄存器, 需要提前备份</p>
<pre><code>mov esi, eax
mov di, cx
</code></pre>
<h3 id="step1-sector-count">step1: 选择通道, 往该通道的sector count寄存器中写入待操作的扇区数</h3>
<ul>
<li>Primary: &mdash;&gt; 0x1F2</li>
<li>Secondary: -&gt; 0x172</li>
</ul>
<p>比如选择主通道(ps:通道其实就是IDE插槽, 一个通道上可以挂2块盘(主盘、从盘))</p>
<pre><code>mov dx, 0x1f2
mov al, cl      ; cl 事先放好待操作的扇区数
out dx, al
</code></pre>
<h3 id="step2-lba-lba24">step2: 设置lba地址, 往该通道上的三个lba寄存器中写入扇区起始地址的低24位</h3>
<pre><code>mov eax, esi    ; 恢复eax, eax事先放好扇区起始地址

; lbalow
mov dx, 0x1f3
out dx, al

; lbamid
mov cl, 8
shr eax, cl     ; 右移8位, 截取相对高位
mov dx, 0x1f4
out dx, al

; lbahigh
shr eax, cl
mov dx, 0x1f5
out dx, al
</code></pre>
<h3 id="step3-devicelba2427-61lba-master-or-slave">step3: 往device寄存器中写入lba地址的24~27位, 并置第6位为1(LBA模式), 选择操作的硬盘(master or slave)</h3>
<p>上一下device寄存器的结构:</p>
<pre><code>device寄存器  (位)   0     1      2     3    4     5     6      7
              (开关) -LBA地址的第23~27位- 主/从盘  1  寻址模式  1
</code></pre>
<p>代码:</p>
<pre><code>; lba address
shr eax, cl
or al, 0xe0     ; 11100000 -&gt; 高3位全部置为1
mov dx, 0x1f6
out dx, al
</code></pre>
<h3 id="step4-command">step4: 往通道的command寄存器写入操作命令</h3>
<p>写入操作命令时需要检测状态寄存器, 判断当前硬盘是否繁忙(有无命令执行). 状态寄存器结构:</p>
<pre><code>status寄存器  (位)   0  1  2  3  4  5  6      7
              (开关) ERR     DRQ      DRDY   BSY
              (为1表示有错误 错误信息见error端口)
</code></pre>
<p>代码:</p>
<pre><code>mov dx, 0x1f7
mov al, 0x20    ; 01000000
out dx, al      ; 写入命令, 状态寄存器就"变成了"命令寄存器...(weird, right?)
                ; 硬盘开始工作
</code></pre>
<h3 id="step5">step5: 读取硬盘中的数据</h3>
<pre><code>.not_ready:
    nop             ; 空操作, 类似sleep
    in al, dx       ; 读取状态寄存器(无需重新初始化dx寄存器)
    and al, 0x88    ; 10001000 检测BSY和DRQ
    cmp al, 0x08    ; 00001000 检测BSY位
    jnz .not_ready  ; 判断结果是否为0, 得出此时的硬盘工作状态

; 从0x1f0端口(primary通道的data寄存器)读数据
    mov ax, di      ; di&lt;-cx&lt;-待读入的扇区数
    mov dx, 256     ; (512)/2&lt;-一次in读取2个字节: 每个扇区in操作的次数
    mul dx          ; 乘法操作, dx是操作数, 另一个操作数隐含在ax或al寄存器中
                    ; -&gt; [待读入的扇区数*每个扇区in操作的次数] = 4*256 = 1024
                    ; -&gt; 16位乘法32位乘积的低16位在ax寄存器, 高16位在dx寄存器
    mov cx, ax      ; cx作为loop循环计数
                    ; -&gt; ax: 1024, 1024次循环,每次2个字节,正好2048-&gt;4个扇区,能够完全读取mbr

    mov dx, 0x1f0   ; 访问0x1f0寄存器读取数据

  .go_on_read:
    in ax, dx       ; 从Primary通道主盘读数据
    mov [bx], ax    ; 把加载器写入内存: bx存放加载器所在的内存地址: 0x900
    add bx, 2       ; 移动2个字节
    loop .go_on_read; 循环
    ret             ; 函数返回, call函数的时候会将返回地址压入栈中
</code></pre>
<p>检测状态寄存器(读操作)BSY位, 循环读取[之前传入的扇区数]个扇区</p>
<pre><code>mov dx, 0x1f0
in ax, dx
mov [bx], ax
</code></pre>
<p>这3步实现从硬盘中读出数据并加载到内存. uiharu的loader、kernel.bin、kernel image都是这样读写的!</p>
            </div>
        </div>
    </div>
    <div id="disqus_thread" style="padding: 50px"></div>
    <script>
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = '//neo1218flask.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

    </div>
</main>
<footer>
    <div id="foot">
        
            <div class="footer">
                <span>
                    Powered by:
                    <a href="https://github.com/neo1218/railgun/" target="_blank">railgun</a>
                    I am a loser
                </span>
                <br>
            </div>
        
    </div>
</footer>
<div id="back-to-top" data-scroll="body" style="top: -900px;">
</div>
</body>
    <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
    <script src=/static/js/base_site.js></script>
    <script src=/static/js/disqus/embed.js></script>
    <script src=/static/js/menufix.js></script>
    <script src=/static/js/backtotop.js></script>
    <script type="text/javascript">
        function loadMenuFix() { menufix("info_card"); }
        function loadDeadCat() { deadcat("toTop"); }
        function addLoadEvent(func) {
            var oldonload = window.onload;
            if (typeof window.onload != 'function') {
                window.onload = func;
            } else {
                window.onload = function() {
                    if (oldonload) {
                        oldonload();
                    }
                    func();
                }
            }
        }
        addLoadEvent(loadMenuFix);
        // addLoadEvent(loadDeadCat);
    </script>
</html>