<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    
    
    <!-- google site -->
    <meta name="google-site-verification" content="BazmSJ55LY7H3RD6ttelAsE8PmOPjhkFnDdIjFMCiJE" />
    <title>neo1218ã®å®¶ - POST</title>
    <link rel="shortcut icon" href="http://7xj431.com1.z0.glb.clouddn.com/cropped-150-150-688417.png" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href=/static/css/base_site.css>
    <link rel="stylesheet" type="text/css" href=/static/css/index.css>
    <link rel="stylesheet" type="text/css" href=/static/css/post.css>
    <link rel="stylesheet" type="text/css" href=/static/css/self_card.css>
    <link rel="stylesheet" type="text/css" href=/static/css/github.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/github.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/facebook.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/twitter.css>
    <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link href=/static/image/bg.png>
</head>
<body>
<header>
    <div class="top-z-container">
        <!--blur-->
        <div class="blur-top-image"></div>
        <div id="top-bar">
            <nav class="left-box">
                <ul>
                    <li>
                        <a href=/>neo1218ã®å®¶</a> - Pythoner Vimer æœ¨çŠ€ hacker
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    <div id="top-image"></div>
    <nav class="nav-wrapper">
        <ul class="category-list">
            <li>
                <a href=/>
                    <span>é¦–é¡µ</span>
                    <div class="menu-icon-wrapper">
                        <span class="menu-icon icon-no-bg-color fa fa-home"></span>
                    </div>
                </a>
            </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Web/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">9</span>
                        </div>
                        Web
                    </a>
                    <ul class="drop-down" align="center">
                        <span>Webå¼€å‘</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Life/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">3</span>
                        </div>
                        Life
                    </a>
                    <ul class="drop-down" align="center">
                        <span>ç”Ÿæ´»éšç¬”</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Read/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">1</span>
                        </div>
                        Read
                    </a>
                    <ul class="drop-down" align="center">
                        <span>è¯»ä¹¦</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Python/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">16</span>
                        </div>
                        Python
                    </a>
                    <ul class="drop-down" align="center">
                        <span>Pythonå­¦ä¹ </span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Other/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">3</span>
                        </div>
                        Other
                    </a>
                    <ul class="drop-down" align="center">
                        <span>å…¶ä»–</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/DIY/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">4</span>
                        </div>
                        DIY
                    </a>
                    <ul class="drop-down" align="center">
                        <span>ä¸ªäººé¡¹ç›®</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/C%26Cpp/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">1</span>
                        </div>
                        C&amp;Cpp
                    </a>
                    <ul class="drop-down" align="center">
                        <span>å™¶å“ˆå“ˆ</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/OS/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">7</span>
                        </div>
                        OS
                    </a>
                    <ul class="drop-down" align="center">
                        <span>æ“ä½œç³»ç»Ÿå­¦ä¹ </span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Math/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">1</span>
                        </div>
                        Math
                    </a>
                    <ul class="drop-down" align="center">
                        <span>æ•°å­¦ä¹‹ç¾</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Algo/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">7</span>
                        </div>
                        Algo
                    </a>
                    <ul class="drop-down" align="center">
                        <span>ç®—æ³•å­¦ä¹ </span>
                    </ul>
                </li>
            
            <li>
                <a href=/about/>
                    <span>å…³äº</span>
                    <div class="menu-icon-wrapper">
                        <span class="menu-icon icon-no-bg-color fa fa-info"></span>
                    </div>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main>
    <div id="main">
        
<div class="post-body-wrapper">
    <div class="main_post">
        <h1>ç”¨æ±‡ç¼–è¯»å†™ç¡¬ç›˜</h1>
        <h3>2016-12-13 19:45:00</h3>
        <div class="post_body">
            <div id="post">
                <h1 id="_1">ç”¨æ±‡ç¼–è¯»å†™ç¡¬ç›˜</h1>
<p>ç›´æ¥ç”¨æ±‡ç¼–è¯»å†™ç¡¬ç›˜, å¾ˆcool, ä½†æ˜¯æœ‰ç‚¹éº»çƒ¦, åœ¨æ­¤åšä¸ªç®€å•çš„çºªå½•ğŸ“ </p>
<h2 id="_2">ç¡¬ç›˜é€‚é…å™¨ç«¯å£åŠåŠŸèƒ½åˆ†é…</h2>
<p>åœ¨è¿™ç¯‡åšå®¢<a href="https://neo1218.github.io/disk/">å‘ƒ,ç¡¬ç›˜</a>é‡Œ</p>
<h2 id="_3">è¯»å†™æ­¥éª¤</h2>
<h3 id="step0">step0: å¤‡ä»½å¯„å­˜å™¨</h3>
<p>ç¡¬ç›˜è¯»å†™ä¼šç”¨åˆ°eax, cxå¯„å­˜å™¨, éœ€è¦æå‰å¤‡ä»½</p>
<pre><code>mov esi, eax
mov di, cx
</code></pre>
<h3 id="step1-sector-count">step1: é€‰æ‹©é€šé“, å¾€è¯¥é€šé“çš„sector countå¯„å­˜å™¨ä¸­å†™å…¥å¾…æ“ä½œçš„æ‰‡åŒºæ•°</h3>
<ul>
<li>Primary: &mdash;&gt; 0x1F2</li>
<li>Secondary: -&gt; 0x172</li>
</ul>
<p>æ¯”å¦‚é€‰æ‹©ä¸»é€šé“(ps:é€šé“å…¶å®å°±æ˜¯IDEæ’æ§½, ä¸€ä¸ªé€šé“ä¸Šå¯ä»¥æŒ‚2å—ç›˜(ä¸»ç›˜ã€ä»ç›˜))</p>
<pre><code>mov dx, 0x1f2
mov al, cl      ; cl äº‹å…ˆæ”¾å¥½å¾…æ“ä½œçš„æ‰‡åŒºæ•°
out dx, al
</code></pre>
<h3 id="step2-lba-lba24">step2: è®¾ç½®lbaåœ°å€, å¾€è¯¥é€šé“ä¸Šçš„ä¸‰ä¸ªlbaå¯„å­˜å™¨ä¸­å†™å…¥æ‰‡åŒºèµ·å§‹åœ°å€çš„ä½24ä½</h3>
<pre><code>mov eax, esi    ; æ¢å¤eax, eaxäº‹å…ˆæ”¾å¥½æ‰‡åŒºèµ·å§‹åœ°å€

; lbalow
mov dx, 0x1f3
out dx, al

; lbamid
mov cl, 8
shr eax, cl     ; å³ç§»8ä½, æˆªå–ç›¸å¯¹é«˜ä½
mov dx, 0x1f4
out dx, al

; lbahigh
shr eax, cl
mov dx, 0x1f5
out dx, al
</code></pre>
<h3 id="step3-devicelba2427-61lba-master-or-slave">step3: å¾€deviceå¯„å­˜å™¨ä¸­å†™å…¥lbaåœ°å€çš„24~27ä½, å¹¶ç½®ç¬¬6ä½ä¸º1(LBAæ¨¡å¼), é€‰æ‹©æ“ä½œçš„ç¡¬ç›˜(master or slave)</h3>
<p>ä¸Šä¸€ä¸‹deviceå¯„å­˜å™¨çš„ç»“æ„:</p>
<pre><code>deviceå¯„å­˜å™¨  (ä½)   0     1      2     3    4     5     6      7
              (å¼€å…³) -LBAåœ°å€çš„ç¬¬23~27ä½- ä¸»/ä»ç›˜  1  å¯»å€æ¨¡å¼  1
</code></pre>
<p>ä»£ç :</p>
<pre><code>; lba address
shr eax, cl
or al, 0xe0     ; 11100000 -&gt; é«˜3ä½å…¨éƒ¨ç½®ä¸º1
mov dx, 0x1f6
out dx, al
</code></pre>
<h3 id="step4-command">step4: å¾€é€šé“çš„commandå¯„å­˜å™¨å†™å…¥æ“ä½œå‘½ä»¤</h3>
<p>å†™å…¥æ“ä½œå‘½ä»¤æ—¶éœ€è¦æ£€æµ‹çŠ¶æ€å¯„å­˜å™¨, åˆ¤æ–­å½“å‰ç¡¬ç›˜æ˜¯å¦ç¹å¿™(æœ‰æ— å‘½ä»¤æ‰§è¡Œ). çŠ¶æ€å¯„å­˜å™¨ç»“æ„:</p>
<pre><code>statuså¯„å­˜å™¨  (ä½)   0  1  2  3  4  5  6      7
              (å¼€å…³) ERR     DRQ      DRDY   BSY
              (ä¸º1è¡¨ç¤ºæœ‰é”™è¯¯ é”™è¯¯ä¿¡æ¯è§errorç«¯å£)
</code></pre>
<p>ä»£ç :</p>
<pre><code>mov dx, 0x1f7
mov al, 0x20    ; 01000000
out dx, al      ; å†™å…¥å‘½ä»¤, çŠ¶æ€å¯„å­˜å™¨å°±"å˜æˆäº†"å‘½ä»¤å¯„å­˜å™¨...(weird, right?)
                ; ç¡¬ç›˜å¼€å§‹å·¥ä½œ
</code></pre>
<h3 id="step5">step5: è¯»å–ç¡¬ç›˜ä¸­çš„æ•°æ®</h3>
<pre><code>.not_ready:
    nop             ; ç©ºæ“ä½œ, ç±»ä¼¼sleep
    in al, dx       ; è¯»å–çŠ¶æ€å¯„å­˜å™¨(æ— éœ€é‡æ–°åˆå§‹åŒ–dxå¯„å­˜å™¨)
    and al, 0x88    ; 10001000 æ£€æµ‹BSYå’ŒDRQ
    cmp al, 0x08    ; 00001000 æ£€æµ‹BSYä½
    jnz .not_ready  ; åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0, å¾—å‡ºæ­¤æ—¶çš„ç¡¬ç›˜å·¥ä½œçŠ¶æ€

; ä»0x1f0ç«¯å£(primaryé€šé“çš„dataå¯„å­˜å™¨)è¯»æ•°æ®
    mov ax, di      ; di&lt;-cx&lt;-å¾…è¯»å…¥çš„æ‰‡åŒºæ•°
    mov dx, 256     ; (512)/2&lt;-ä¸€æ¬¡inè¯»å–2ä¸ªå­—èŠ‚: æ¯ä¸ªæ‰‡åŒºinæ“ä½œçš„æ¬¡æ•°
    mul dx          ; ä¹˜æ³•æ“ä½œ, dxæ˜¯æ“ä½œæ•°, å¦ä¸€ä¸ªæ“ä½œæ•°éšå«åœ¨axæˆ–alå¯„å­˜å™¨ä¸­
                    ; -&gt; [å¾…è¯»å…¥çš„æ‰‡åŒºæ•°*æ¯ä¸ªæ‰‡åŒºinæ“ä½œçš„æ¬¡æ•°] = 4*256 = 1024
                    ; -&gt; 16ä½ä¹˜æ³•32ä½ä¹˜ç§¯çš„ä½16ä½åœ¨axå¯„å­˜å™¨, é«˜16ä½åœ¨dxå¯„å­˜å™¨
    mov cx, ax      ; cxä½œä¸ºloopå¾ªç¯è®¡æ•°
                    ; -&gt; ax: 1024, 1024æ¬¡å¾ªç¯,æ¯æ¬¡2ä¸ªå­—èŠ‚,æ­£å¥½2048-&gt;4ä¸ªæ‰‡åŒº,èƒ½å¤Ÿå®Œå…¨è¯»å–mbr

    mov dx, 0x1f0   ; è®¿é—®0x1f0å¯„å­˜å™¨è¯»å–æ•°æ®

  .go_on_read:
    in ax, dx       ; ä»Primaryé€šé“ä¸»ç›˜è¯»æ•°æ®
    mov [bx], ax    ; æŠŠåŠ è½½å™¨å†™å…¥å†…å­˜: bxå­˜æ”¾åŠ è½½å™¨æ‰€åœ¨çš„å†…å­˜åœ°å€: 0x900
    add bx, 2       ; ç§»åŠ¨2ä¸ªå­—èŠ‚
    loop .go_on_read; å¾ªç¯
    ret             ; å‡½æ•°è¿”å›, callå‡½æ•°çš„æ—¶å€™ä¼šå°†è¿”å›åœ°å€å‹å…¥æ ˆä¸­
</code></pre>
<p>æ£€æµ‹çŠ¶æ€å¯„å­˜å™¨(è¯»æ“ä½œ)BSYä½, å¾ªç¯è¯»å–[ä¹‹å‰ä¼ å…¥çš„æ‰‡åŒºæ•°]ä¸ªæ‰‡åŒº</p>
<pre><code>mov dx, 0x1f0
in ax, dx
mov [bx], ax
</code></pre>
<p>è¿™3æ­¥å®ç°ä»ç¡¬ç›˜ä¸­è¯»å‡ºæ•°æ®å¹¶åŠ è½½åˆ°å†…å­˜. uiharuçš„loaderã€kernel.binã€kernel imageéƒ½æ˜¯è¿™æ ·è¯»å†™çš„!</p>
            </div>
        </div>
    </div>
    <div id="disqus_thread" style="padding: 50px"></div>
    <script>
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = '//neo1218flask.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

    </div>
</main>
<footer>
    <div id="foot">
        
            <div class="footer">
                <span>
                    Powered by:
                    <a href="https://github.com/neo1218/railgun/" target="_blank">railgun</a>
                    I am a loser
                </span>
                <br>
            </div>
        
    </div>
</footer>
<div id="back-to-top" data-scroll="body" style="top: -900px;">
</div>
</body>
    <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
    <script src=/static/js/base_site.js></script>
    <script src=/static/js/disqus/embed.js></script>
    <script src=/static/js/menufix.js></script>
    <script src=/static/js/backtotop.js></script>
    <script type="text/javascript">
        function loadMenuFix() { menufix("info_card"); }
        function loadDeadCat() { deadcat("toTop"); }
        function addLoadEvent(func) {
            var oldonload = window.onload;
            if (typeof window.onload != 'function') {
                window.onload = func;
            } else {
                window.onload = function() {
                    if (oldonload) {
                        oldonload();
                    }
                    func();
                }
            }
        }
        addLoadEvent(loadMenuFix);
        // addLoadEvent(loadDeadCat);
    </script>
</html>