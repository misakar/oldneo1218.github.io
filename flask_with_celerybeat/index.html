<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    
    
    <!-- google site -->
    <meta name="google-site-verification" content="BazmSJ55LY7H3RD6ttelAsE8PmOPjhkFnDdIjFMCiJE" />
    <title>neo1218の死宅 - POST</title>
    <link rel="shortcut icon" href="http://7xj431.com1.z0.glb.clouddn.com/cropped-150-150-688417.png" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href=/static/css/base_site.css>
    <link rel="stylesheet" type="text/css" href=/static/css/index.css>
    <link rel="stylesheet" type="text/css" href=/static/css/post.css>
    <link rel="stylesheet" type="text/css" href=/static/css/self_card.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/github.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/facebook.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/twitter.css>
    <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/pygments.css">
    <link href=/static/image/bg.png>
</head>
<body>
<header>
    <div class="top-z-container">
        <!--blur-->
        <div class="blur-top-image"></div>
        <div id="top-bar">
            <nav class="left-box">
                <ul>
                    <li>
                        <a href=/>neo1218の死宅</a> - Pythoner 死宅到底 不想说话 木犀万岁!
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    <div id="top-image"></div>
    <nav class="nav-wrapper">
        <ul class="category-list">
            <li>
                <a href=/>
                    <span>首页</span>
                    <div class="menu-icon-wrapper">
                        <span class="menu-icon icon-no-bg-color fa fa-home"></span>
                    </div>
                </a>
            </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Web/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">7</span>
                        </div>
                        Web
                    </a>
                    <ul class="drop-down" align="center">
                        <span>Web开发</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Life/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">2</span>
                        </div>
                        Life
                    </a>
                    <ul class="drop-down" align="center">
                        <span>生活随笔</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Python/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">15</span>
                        </div>
                        Python
                    </a>
                    <ul class="drop-down" align="center">
                        <span>Python学习</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Other/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">3</span>
                        </div>
                        Other
                    </a>
                    <ul class="drop-down" align="center">
                        <span>其他</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/DIY/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">4</span>
                        </div>
                        DIY
                    </a>
                    <ul class="drop-down" align="center">
                        <span>个人项目</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/OS/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">5</span>
                        </div>
                        OS
                    </a>
                    <ul class="drop-down" align="center">
                        <span>操作系统学习</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Algo/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">7</span>
                        </div>
                        Algo
                    </a>
                    <ul class="drop-down" align="center">
                        <span>算法学习</span>
                    </ul>
                </li>
            
            <li>
                <a href=/about/>
                    <span>关于</span>
                    <div class="menu-icon-wrapper">
                        <span class="menu-icon icon-no-bg-color fa fa-info"></span>
                    </div>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main>
    <div id="main">
        
<div class="post-body-wrapper">
    <div class="main_post">
        <h1>Flask配置celery定时任务</h1>
        <h3>2016-06-19 10:39:12</h3>
        <div class="post_body">
            <p>本篇博客主要通过<strong>代码</strong>总结一下, 如何在一个Flask项目中使用Celery队列定时执行任务.</p>

<h2 id="celery">配置Celery</h2>

<p>配置项:<br><br />
<a href="http://docs.celeryproject.org/en/master/getting-started/first-steps-with-celery.html#choosing-a-broker">Broker</a>(使用redis)<code>CELERY_BROKER_URL=&rsquo;redis://localhost:6379&rsquo;</code><br/><br />
<a href="http://docs.celeryproject.org/en/master/getting-started/first-steps-with-celery.html#keeping-results">Backend</a>(使用redis)<code>CELERY_RESULT_BACKEND=&rsquo;redis://localhost:6379&rsquo;&lt;/code</p>

<h2 id="make_celery">编写make_celery工厂函数</h2>

<pre><code class="python">    from celery import Celery

    def make_celery(app):
        celery = Celery(app.import_name, broker=app.config['CELERY_BROKER_URL'])
        celery.conf.update(app.config)
        TaskBase = celery.Task
        class ContextTask(TaskBase):
            abstruct = True
            def __call__(self, *args, **keywords):
                with app.app_context():
                    return TaskBase.__call__(self, *args, **keywords)
        celery.Task = ContextTask
        return celery
</code></pre>

<p>这个工厂函数做了一点手脚(ContextTask), 这样就可以在celery task中使用flask对象(app context)</p>

<h2 id="task">编写task</h2>

<p>使用@celery.task装饰器编写celery任务</p>

<pre><code class="python">    celery = make_celery(app)

    @celery.task(name=printy)
    def printy():
        print &quot;hahahahaha&quot;
</code></pre>

<h2 id="celery_1">定时celery任务</h2>

<p>使用<code>CELERYBEAT_SCHEDULE</code>配置celery任务定时</p>

<pre><code>from datetime import timedelta

CELERYBEAT_SCHEDULE = {
    'printy': {
        'task': 'printy',
        'schedule': timedelta(seconds=10)
    },
}
</code></pre>

<p>这里设置printy任务每隔10s触发一次.<br/><br />
因为在<code>make_celery</code>函数中<code>celery.conf.update(app.config)</code><br />
所以如果希望celery读取CELERYBEAT_SCHEDULE, 把CELERYBEAT_SCHEDULE放到flask app的配置中就行了.</p>

<h2 id="celery_2">启动celery</h2>

<p>依次启动:举个例子<br/></p>

<ol>
<li>flask project: <code>python manage.py runserver</code></li>
<li>redis(backend): <code>redis-server &ndash;port 6380</code></li>
<li>redis(broker): <code>redis-server &ndash;port 6382</code></li>
<li>celery(main process): <code>celery worker &ndash;app xxx.celery &ndash;loglevel=info</code></li>
<li>celery(beat): <code>celery beat &ndash;app xxx.celery &ndash;loglevel=info</code></li>
</ol>

<p>当然，比较好的管理方法是使用supervisor,具体参见博文<a href="http://neo1218.github.io/blog/supervisor/">Python进程管理工具supervisor</a></p>

<h2 id="flask-celery">更多关于Flask❤️ Celery</h2>

<ul>
<li><a href="http://blog.miguelgrinberg.com/post/using-celery-with-flask">using-celery-with-flask</a></li>
<li><a href="http://www.it1me.com/it-answers?id=29670961&amp;s=Kiev&amp;ttl=Flask%2C+blueprints+uses+celery+task+and+got+cycle+import">Flask, blueprints uses celery task and got cycle import</a></li>
</ul>

        </div>
    </div>
    <div id="disqus_thread" style="padding: 50px"></div>
    <script>
    /**
    * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = '//neo1218flask.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

    </div>
</main>
<footer>
    <div id="foot">
        
            <div class="footer">
                <span>
                    Powered by:
                    <a href="https://github.com/neo1218/railgun/" target="_blank">railgun</a>
                    I am a loser
                </span>
                <br>
            </div>
        
    </div>
</footer>
<a href="#" id="toTop" style="top: 0px;" onclick="scroll_to_top(0.9); return false;">
    <div id="toTopRope"></div>
    <img id="toTopHover" src="http://7xj431.com1.z0.glb.clouddn.com/topscroll.png"></div>
</a>
</body>
    <script src=/static/js/base_site.js> </script>
    <script src=/static/js/disqus/embed.js></script>
</html>