<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    
    
    <!-- google site -->
    <meta name="google-site-verification" content="BazmSJ55LY7H3RD6ttelAsE8PmOPjhkFnDdIjFMCiJE" />
    <title>neo1218ã®æ­»å®… - POST</title>
    <link rel="shortcut icon" href="http://7xj431.com1.z0.glb.clouddn.com/cropped-150-150-688417.png" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href=/static/css/base_site.css>
    <link rel="stylesheet" type="text/css" href=/static/css/index.css>
    <link rel="stylesheet" type="text/css" href=/static/css/post.css>
    <link rel="stylesheet" type="text/css" href=/static/css/self_card.css>
    <link rel="stylesheet" type="text/css" href=/static/css/github.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/github.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/facebook.css>
    <link rel="stylesheet" type="text/css" href=/static/css/logo/twitter.css>
    <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link href=/static/image/bg.png>
</head>
<body>
<header>
    <div class="top-z-container">
        <!--blur-->
        <div class="blur-top-image"></div>
        <div id="top-bar">
            <nav class="left-box">
                <ul>
                    <li>
                        <a href=/>neo1218ã®æ­»å®…</a> - Pythoner æ­»å®…åˆ°åº• ä¸æƒ³è¯´è¯ æœ¨çŠ€ä¸‡å²!
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    <div id="top-image"></div>
    <nav class="nav-wrapper">
        <ul class="category-list">
            <li>
                <a href=/>
                    <span>é¦–é¡µ</span>
                    <div class="menu-icon-wrapper">
                        <span class="menu-icon icon-no-bg-color fa fa-home"></span>
                    </div>
                </a>
            </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Web/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">7</span>
                        </div>
                        Web
                    </a>
                    <ul class="drop-down" align="center">
                        <span>Webå¼€å‘</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Life/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">3</span>
                        </div>
                        Life
                    </a>
                    <ul class="drop-down" align="center">
                        <span>ç”Ÿæ´»éšç¬”</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Read/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">1</span>
                        </div>
                        Read
                    </a>
                    <ul class="drop-down" align="center">
                        <span>None</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Python/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">16</span>
                        </div>
                        Python
                    </a>
                    <ul class="drop-down" align="center">
                        <span>Pythonå­¦ä¹ </span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Other/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">3</span>
                        </div>
                        Other
                    </a>
                    <ul class="drop-down" align="center">
                        <span>å…¶ä»–</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/DIY/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">4</span>
                        </div>
                        DIY
                    </a>
                    <ul class="drop-down" align="center">
                        <span>ä¸ªäººé¡¹ç›®</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/C%26Cpp/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">1</span>
                        </div>
                        C&amp;Cpp
                    </a>
                    <ul class="drop-down" align="center">
                        <span>None</span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/OS/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">5</span>
                        </div>
                        OS
                    </a>
                    <ul class="drop-down" align="center">
                        <span>æ“ä½œç³»ç»Ÿå­¦ä¹ </span>
                    </ul>
                </li>
            
                <li onmouseover="show_menu(this)" onmouseout="hide_menu(this)">
                    <a href=/tag/Algo/>
                        <div class="menu-icon-wrapper">
                            <span class="menu-icon">7</span>
                        </div>
                        Algo
                    </a>
                    <ul class="drop-down" align="center">
                        <span>ç®—æ³•å­¦ä¹ </span>
                    </ul>
                </li>
            
            <li>
                <a href=/about/>
                    <span>å…³äº</span>
                    <div class="menu-icon-wrapper">
                        <span class="menu-icon icon-no-bg-color fa fa-info"></span>
                    </div>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main>
    <div id="main">
        
<div class="post-body-wrapper">
    <div class="main_post">
        <h1>Pythonå°¾é€’å½’ä¼˜åŒ–</h1>
        <h3>2016-11-30 16:37:53</h3>
        <div class="post_body">
            <h1 id="python">Pythonå°¾é€’å½’ä¼˜åŒ–</h1>

<h2 id="_1">ä¸€èˆ¬é€’å½’ä¸å°¾é€’å½’</h2>

<h4 id="_2">ä¸€èˆ¬é€’å½’:</h4>

<pre><code>def normal_recursion(n):
    if n == 1:
        return 1
    else:
        return n + normal_recursion(n-1)
</code></pre>

<p>æ‰§è¡Œï¼š</p>

<pre><code>normal_recursion(5)
5 + normal_recursion(4)
5 + 4 + normal_recursion(3)
5 + 4 + 3 + normal_recursion(2)
5 + 4 + 3 + 2 + normal_recursion(1)
5 + 4 + 3 + 3
5 + 4 + 6
5 + 10
15
</code></pre>

<p>å¯ä»¥çœ‹åˆ°, ä¸€èˆ¬é€’å½’, æ¯ä¸€çº§é€’å½’éƒ½éœ€è¦è°ƒç”¨å‡½æ•°, ä¼šåˆ›å»ºæ–°çš„æ ˆ,<br />
éšç€é€’å½’æ·±åº¦çš„å¢åŠ , åˆ›å»ºçš„æ ˆè¶Šæ¥è¶Šå¤š, é€ æˆçˆ†æ ˆğŸ’¥ </p>

<h4 id="_3">å°¾é€’å½’</h4>

<p><a href="https://zh.wikipedia.org/wiki/%E5%B0%BE%E8%B0%83%E7%94%A8">å°¾é€’å½’åŸºäºå‡½æ•°çš„å°¾è°ƒç”¨</a>, æ¯ä¸€çº§è°ƒç”¨ç›´æ¥è¿”å›å‡½æ•°çš„è¿”å›å€¼æ›´æ–°è°ƒç”¨æ ˆ,è€Œä¸ç”¨åˆ›å»ºæ–°çš„è°ƒç”¨æ ˆ, ç±»ä¼¼è¿­ä»£çš„å®ç°, æ—¶é—´å’Œç©ºé—´ä¸Šå‡ä¼˜åŒ–äº†ä¸€èˆ¬é€’å½’!</p>

<pre><code>def tail_recursion(n, total=0):
    if n == 0:
        return total
    else:
        return tail_recursion(n-1, total+n)
</code></pre>

<p>æ‰§è¡Œï¼š</p>

<pre><code>tail_recursion(5)
tail_recursion(4, 5)
tail_recursion(3, 9)
tail_recursion(2, 12)
tail_recursion(1, 14)
tail_recursion(0, 15)
15
</code></pre>

<p>å¯ä»¥çœ‹åˆ°, æ¯ä¸€çº§é€’å½’çš„å‡½æ•°è°ƒç”¨å˜æˆ&rdquo;çº¿æ€§&rdquo;çš„å½¢å¼. </p>

<h2 id="_4">æ·±å…¥ç†è§£å°¾é€’å½’</h2>

<p>å‘ƒ, æ‰€ä»¥å‘¢? æ˜¯ä¸æ˜¯æ„Ÿè§‰è¿˜ä¸å¤Ÿè¿‡ç˜¾&hellip; è°è¯´å°¾é€’å½’è°ƒç”¨å°±ä¸ç”¨åˆ›å»ºæ–°çš„æ ˆå‘¢?<br />
è¿˜æ˜¯è®©æˆ‘ä»¬å»åº•å±‚ä¸€æ¢ç©¶ç«Ÿå§<br/></p>

<pre><code>int tail_recursion(int n, int total) {
    if (n == 0) {
        return total;
    }
    else {
        return tail_recursion(n-1, total+n);
    }
}

int main(void) {
    int total = 0, n = 4;
    tail_recursion(n, total);
    return 0;
}
</code></pre>

<p><strong>åæ±‡ç¼–</strong> <br/></p>

<ul>
<li><code>$ gcc -S tail_recursion.c -o normal_recursion.S</code></li>
<li><code>$ gcc -S -O2 tail_recursion.c -o tail_recursion.S</code> gccå¼€å¯å°¾é€’å½’ä¼˜åŒ–</li>
</ul>

<p>å¯¹æ¯”åæ±‡ç¼–ä»£ç å¦‚ä¸‹(AT&amp;Tè¯­æ³•) <br/><br />
<img alt="" src="https://cloud.githubusercontent.com/assets/10671733/20724681/24cfaffe-b6aa-11e6-85f8-fee65848f533.png" /></p>

<p>å¯ä»¥çœ‹åˆ°, å¼€å¯å°¾é€’å½’ä¼˜åŒ–å‰, ä½¿ç”¨callè°ƒç”¨å‡½æ•°, åˆ›å»ºäº†æ–°çš„è°ƒç”¨æ ˆ(LBB0_3);<br />
è€Œå¼€å¯å°¾é€’å½’ä¼˜åŒ–å, å°±æ²¡æœ‰æ–°çš„è°ƒç”¨æ ˆç”Ÿæˆäº†, è€Œæ˜¯ç›´æ¥pop<br />
bpæŒ‡å‘çš„<code>_tail_recursion</code>å‡½æ•°çš„åœ°å€(pushq %rbp)ç„¶åè¿”å›,<br />
<img alt="" src="https://cloud.githubusercontent.com/assets/10671733/20724912/13fc5b22-b6ab-11e6-84db-80126d4601a6.png" /><br />
ä»æ—§ç”¨çš„æ˜¯åŒä¸€ä¸ªè°ƒç”¨æ ˆ!</p>

<h2 id="_5">å­˜åœ¨çš„é—®é¢˜</h2>

<p>è™½ç„¶å°¾é€’å½’ä¼˜åŒ–å¾ˆå¥½, ä½†python ä¸æ”¯æŒå°¾é€’å½’ï¼Œé€’å½’æ·±åº¦è¶…è¿‡1000æ—¶ä¼šæŠ¥é”™</p>

<pre><code>RuntimeError: maximum recursion depth exceeded
</code></pre>

<h2 id="_6">ä¸€ä¸ªç‰›äººæƒ³å‡ºçš„è§£å†³åŠæ³•ï¼š</h2>

<h4 id="tail_call_optimized">å®ç°ä¸€ä¸ª tail_call_optimized è£…é¥°å™¨</h4>

<pre><code>#!/usr/bin/env python2.4
# This program shows off a python decorator(
# which implements tail call optimization. It
# does this by throwing an exception if it is
# it's own grandparent, and catching such
# exceptions to recall the stack.

import sys

class TailRecurseException:
    def __init__(self, args, kwargs):
        self.args = args
        self.kwargs = kwargs

def tail_call_optimized(g):
    """
    This function decorates a function with tail call
    optimization. It does this by throwing an exception
    if it is it's own grandparent, and catching such
    exceptions to fake the tail call optimization.

    This function fails if the decorated
    function recurses in a non-tail context.
    """
    def func(*args, **kwargs):
        f = sys._getframe()
        # ä¸ºä»€ä¹ˆæ˜¯grandparent, å‡½æ•°é»˜è®¤çš„ç¬¬ä¸€å±‚é€’å½’æ˜¯çˆ¶è°ƒç”¨,
        # å¯¹äºå°¾é€’å½’, ä¸å¸Œæœ›äº§ç”Ÿæ–°çš„å‡½æ•°è°ƒç”¨(å³:ç¥–çˆ¶è°ƒç”¨),
        # æ‰€ä»¥è¿™é‡ŒæŠ›å‡ºå¼‚å¸¸, æ‹¿åˆ°å‚æ•°, é€€å‡ºè¢«ä¿®é¥°å‡½æ•°çš„é€’å½’è°ƒç”¨æ ˆ!(åé¢æœ‰åŠ¨å›¾åˆ†æ)
        if f.f_back and f.f_back.f_back \
            and f.f_back.f_back.f_code == f.f_code:
            # æŠ›å‡ºå¼‚å¸¸
            raise TailRecurseException(args, kwargs)
        else:
            while 1:
                try:
                    return g(*args, **kwargs)
                except TailRecurseException, e:
                    # æ•è·å¼‚å¸¸, æ‹¿åˆ°å‚æ•°, é€€å‡ºè¢«ä¿®é¥°å‡½æ•°çš„é€’å½’è°ƒç”¨æ ˆ
                    args = e.args
                    kwargs = e.kwargs
    func.__doc__ = g.__doc__
    return func

@tail_call_optimized
def factorial(n, acc=1):
    "calculate a factorial"
    if n == 0:
        return acc
    return factorial(n-1, n*acc)

print factorial(10000)
</code></pre>

<p>ä¸ºäº†æ›´æ¸…æ™°çš„å±•ç¤ºå¼€å¯å°¾é€’å½’ä¼˜åŒ–å‰ã€åè°ƒç”¨æ ˆçš„å˜åŒ–å’Œtail_call_optimizedè£…é¥°å™¨æŠ›å¼‚å¸¸é€€å‡ºé€’å½’è°ƒç”¨æ ˆçš„ä½œç”¨, æˆ‘è¿™é‡Œåˆ©ç”¨<a href="https://github.com/inducer/pudb">pudbè°ƒè¯•å·¥å…·</a>åšäº†åŠ¨å›¾ <br/></p>

<p>å¼€å¯å°¾é€’å½’ä¼˜åŒ–å‰çš„è°ƒç”¨æ ˆ <br/><br />
<img alt="" src="https://cloud.githubusercontent.com/assets/10671733/20725973/b4e5d060-b6ae-11e6-9116-265cdd871b36.gif" /> <br/><br />
å¼€å¯å°¾é€’å½’ä¼˜åŒ–å(tail_call_optimizedè£…é¥°å™¨)çš„è°ƒç”¨æ ˆ <br/><br />
<img alt="" src="https://cloud.githubusercontent.com/assets/10671733/20726110/1cfc8568-b6af-11e6-9817-1257b4c482f1.gif" /> <br/></p>

<p>é€šè¿‡pudbå³è¾¹æ çš„stack, å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°è°ƒç”¨æ ˆçš„å˜åŒ–. <br/><br />
å› ä¸ºå°¾é€’å½’æ²¡æœ‰è°ƒç”¨æ ˆçš„åµŒå¥—, æ‰€ä»¥Pythonä¹Ÿä¸ä¼šæŠ¥<code>RuntimeError: maximum recursion depth exceeded</code>é”™è¯¯äº†! <br/></p>

<p>è¿™é‡Œè§£é‡Šä¸€ä¸‹ sys._getframe() å‡½æ•°:<br/></p>

<pre><code>sys._getframe([depth]):
Return a frame object from the call stack.
If optional integer depth is given, return the frame object that many calls below the top of the stack.
If that is deeper than the call stack, ValueEfror is raised. The default for depth is zero,
returning the frame at the top of the call stack.

å³è¿”å›depthæ·±åº¦è°ƒç”¨çš„æ ˆå¸§å¯¹è±¡.

import sys

def get_cur_info():
    print sys._getframe().f_code.co_filename  # å½“å‰æ–‡ä»¶å
    print sys._getframe().f_code.co_name  # å½“å‰å‡½æ•°å
    print sys._getframe().f_lineno # å½“å‰è¡Œå·
    print sys._getframe().f_back # è°ƒç”¨è€…çš„å¸§
</code></pre>

<p>æ›´å¤šå…³äº<code>sys._getframe</code>è¯·çœ‹<a href="http://feihonghsu.com/secrets/framehack/index.html#crazy-monkey-patching-lxml">Frame Hacks</a></p>

        </div>
    </div>
    <div id="disqus_thread" style="padding: 50px"></div>
    <script>
    /**
    * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = '//neo1218flask.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

    </div>
</main>
<footer>
    <div id="foot">
        
            <div class="footer">
                <span>
                    Powered by:
                    <a href="https://github.com/neo1218/railgun/" target="_blank">railgun</a>
                    I am a loser
                </span>
                <br>
            </div>
        
    </div>
</footer>
<!--div id="toTop" style="top: 0px;" onclick="scroll_to_top(0.9); return false;">
    <div id="toTopRope"></div>
    <img id="toTopHover" src="http://7xj431.com1.z0.glb.clouddn.com/topscroll.png"></div>
</div-->
<div id="back-to-top" class="red active" data-scroll="body" style="top: -900px;">
</div>
</body>
    <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
    <script src=/static/js/base_site.js></script>
    <script src=/static/js/disqus/embed.js></script>
    <script src=/static/js/menufix.js></script>
    <script src=/static/js/backtotop.js></script>
    <script type="text/javascript">
        function loadMenuFix() { menufix("info_card"); }
        function loadDeadCat() { deadcat("toTop"); }
        function addLoadEvent(func) {
            var oldonload = window.onload;
            if (typeof window.onload != 'function') {
                window.onload = func;
            } else {
                window.onload = function() {
                    if (oldonload) {
                        oldonload();
                    }
                    func();
                }
            }
        }
        addLoadEvent(loadMenuFix);
        // addLoadEvent(loadDeadCat);
    </script>
</html>